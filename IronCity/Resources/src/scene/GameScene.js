//ExportJson
var Json_CMRun                       = "res/iphone/CMRun.ExportJson";
var Json_CMRunJump                   = "res/iphone/CMRunJump.ExportJson";
var Json_CMRunStop                   = "res/iphone/CMRunStop.ExportJson";
var Json_CMStandJump                = "res/iphone/CMStandJump.ExportJson";
var Json_LaserRunAttack             = "res/iphone/LaserRunAttack.ExportJson";
var Json_LaserStandAttack           = "res/iphone/LaserStandAttack.ExportJson";
var Json_MonsterGroundMoving        = "res/iphone/MonsterGroundMoving.ExportJson";
var Json_MonsterSkyMoving           = "res/iphone/MonsterSkyMoving.ExportJson";
var Json_MonsterGroundAnimation     = "res/iphone/MonsterGroundAnimation.ExportJson";
var Json_MonsterSkyAnimation        = "res/iphone/MonsterSkyAnimation.ExportJson";
var Json_CMDead                       = "res/iphone/CMDead.ExportJson";
//png
var Png_CMRun                        = "res/iphone/CMRun0.png";
var Png_CMRunJump                   = "res/iphone/CMRunJump0.png";
var Png_CMRunStop                   = "res/iphone/CMRunStop0.png";
var Png_CMStandJump                = "res/iphone/CMStandJump0.png";
var Png_LaserRunAttack            = "res/iphone/LaserRunAttack0.png";
var Png_LaserStandAttack          = "res/iphone/LaserStandAttack0.png";
var Png_laser                      = "res/iphone/laser.png";
var s_settingBtn                   = "res/iphone/settingBtn.png";
var s_blood                        = "res/iphone/blood.png";
var s_distance                    = "res/iphone/distance.png";
var s_bloodBar                    = "res/iphone/bloodBar.png";
var s_labelatlasimg              = "res/iphone/labelatlasimg.png";
var s_musicEffectSwitch         = "res/iphone/musicEffectSwitch.png";
var s_musicVolumeSwitch         = "res/iphone/musicVolumeSwitch.png";
var s_musicVolumeBottom         = "res/iphone/musicVolumeBottom.png";
var s_musicVolumeOn                 = "res/iphone/musicVolumeOn.png";
var s_musicVolumeBK                 = "res/iphone/musicVolumeBK.png";
var s_monsterGround                 = "res/iphone/monsterGround.png";
var s_monsterSky                     = "res/iphone/monsterSky.png";
var s_MonsterGroundAnimation_png    = "res/iphone/MonsterGroundAnimation0.png";
var s_MonsterSkyAnimation_png       = "res/iphone/MonsterSkyAnimation0.png";
var s_MonsterGroundMoving_png       = "res/iphone/MonsterGroundMoving0.png";
var s_MonsterSkyMoving_png          = "res/iphone/MonsterSkyMoving0.png";
var Png_CMDead                      = "res/iphone/CMDead0.png";
var png_backGame                  = "res/iphone/backGame.png";
var png_backGamePush             = "res/iphone/backGamePush.png";
var png_backMainMenuBtn         = "res/iphone/backMainMenuBtn.png";
var png_backMainMenuPushBtn    = "res/iphone/backMainMenuPushBtn.png";
var png_playAgainBtn            = "res/iphone/playAgainBtn.png";
var png_playAgainPushBtn       = "res/iphone/playAgainPushBtn.png";
var png_gameOverMenu            = "res/iphone/gameOverMenu.png";
var png_musicEffectOn           = "res/iphone/musicEffectOn.png";
var png_musicEffectOff          = "res/iphone/musicEffectOff.png";

var s_Concreate_wall           = "res/tiled/concrete_wall.png";
var s_attention_line          = "res/tiled/attention_line.png";
var s_cloud                     = "res/tiled/cloud.png";
var s_door                      = "res/tiled/door.png";
var s_floor                     = "res/tiled/floor.png";
var s_house                     = "res/tiled/house.png";
var s_pipe                       = "res/tiled/pipe.png";
var s_pipe2                     = "res/tiled/pipe2.png";
var s_sky                       = "res/tiled/sky.png";
var s_stair                     = "res/tiled/stairs.png";
var s_woonden_ladder           = "res/tiled/wooden_ladder.png";
//plist
var Plist_CMRun                 = "res/iphone/CMRun0.plist";
var Plist_CMRunJump            = "res/iphone/CMRunJump0.plist";
var Plist_CMRunStop            = "res/iphone/CMRunStop0.plist";
var Plist_CMStandJump          = "res/iphone/CMStandJump0.plist";
var Plist_LaserRunAttack       = "res/iphone/LaserRunAttack0.plist";
var Plist_LaserStandAttack0   = "res/iphone/LaserStandAttack0.plist";
var p_MonsterGroundAnimation_plist  = "res/iphone/MonsterGroundAnimation0.plist";
var p_MonsterSkyAnimation_plist     = "res/iphone/MonsterSkyAnimation0.plist";
var p_MonsterGroundMoving_plist     = "res/iphone/MonsterGroundMoving0.plist";
var p_MonsterSkyMoving_plist        = "res/iphone/MonsterSkyMoving0.plist";
var Plist_CMDead                      = "res/iphone/CMDead0.plist";
//tiledmap
var s_bg_1                  = "res/tiled/bg0_0.tmx";
var s_bg_2                  = "res/tiled/bg0_1.tmx";
var s_bg_3                  = "res/tiled/bg0_2.tmx";
var s_bg_10                 = "res/tiled/bg1_0.tmx";
var s_bg_11                 = "res/tiled/bg1_1.tmx";
var s_bg_12                 = "res/tiled/bg1_2.tmx";
var s_bg_20                 = "res/tiled/bg2_0.tmx";
var s_bg_21                 = "res/tiled/bg2_1.tmx";
var s_bg_22                 = "res/tiled/bg2_2.tmx";
//json
var Json_IronCityUI_1       = "res/iphone/IronCityUI_1.json";
var Json_GameSceneSetMenu_1 = "res/iphone/GameSceneSetMenu_1.json";
var Json_GameSceneOverLayer_1       = "res/iphone/GameSceneOverLayer_1.json";
//preLoad
var GameScene_resources =
[
    {src:png_musicEffectOn},
    {src:png_musicEffectOff},

    {src:s_monsterGround},
    {src:s_monsterSky},
    {src:p_MonsterGroundAnimation_plist},
    {src:s_MonsterGroundAnimation_png},
    {src:p_MonsterSkyAnimation_plist},
    {src:s_MonsterSkyAnimation_png},
    {src:p_MonsterGroundMoving_plist},
    {src:s_MonsterGroundMoving_png},
    {src:p_MonsterSkyMoving_plist},
    {src:s_MonsterSkyMoving_png},
    //Jsons
    {src:Json_CMRun},
    {src:Json_CMRunJump},
    {src:Json_CMRunStop},
    {src:Json_CMStandJump},
    {src:Json_LaserRunAttack},
    {src:Json_LaserStandAttack},
    {src:Json_IronCityUI_1},
    {src:Json_GameSceneSetMenu_1},
    {src:Json_GameSceneOverLayer_1},
    {src:Json_MonsterSkyMoving},
    {src:Json_MonsterGroundMoving},
    //Pngs
    {src:Png_CMRun},
    {src:Png_CMRunJump},
    {src:Png_CMRunStop},
    {src:Png_CMStandJump},
    {src:Png_LaserRunAttack},
    {src:Png_LaserStandAttack},
    {src:s_settingBtn},
    {src:s_blood},
    {src:s_distance},
    {src:s_bloodBar},
    {src:s_labelatlasimg},
    {src:s_musicEffectSwitch},
    {src:s_musicVolumeSwitch},
    {src:s_musicVolumeOn},
    {src:s_musicVolumeBK},
    {src:s_musicVolumeBottom},
    {src:Png_laser},
    {src:png_backGame},
    {src:png_backGamePush},
    {src:png_backMainMenuBtn},
    {src:png_backMainMenuPushBtn},
    {src:png_playAgainBtn},
    {src:png_playAgainPushBtn},
    {src:png_gameOverMenu},
    //tiledmap
    {src:s_Concreate_wall},
    {src:s_attention_line},
    {src:s_cloud},
    {src:s_door},
    {src:s_floor},
    {src:s_house},
    {src:s_pipe},
    {src:s_pipe2},
    {src:s_sky},
    {src:s_stair},
    {src:s_woonden_ladder},
    {src:s_bg_1},
    {src:s_bg_2},
    {src:s_bg_3},
    {src:s_bg_10},
    {src:s_bg_11},
    {src:s_bg_12},
    {src:s_bg_20},
    {src:s_bg_21},
    {src:s_bg_22},
    //plists
    {src:Plist_CMRun},
    {src:Plist_CMRunJump},
    {src:Plist_CMRunStop},
    {src:Plist_CMStandJump},
    {src:Plist_LaserRunAttack},
    {src:Plist_LaserStandAttack0},
    {src:Json_CMDead},
    {src:Plist_CMDead},
    {src:Png_CMDead}
];
//scene: game scene.
var GameScene = cc.Scene.extend
({
    moveMap:null,
    menuLayer:null,
    gameSceneMonster:null,
    isRectDetectedLock:false,
    laser:null,
    _STATUS:null,
    onEnter:function ()
    {
        this._super();
        //map
        this.moveMap = new Background();
        this.moveMap.init();
        this.moveMap.setMovedSpeed(3);
        this.addChild(this.moveMap, 0);

        //menu
        this.menuLayer = new MenuUI();
        this.menuLayer.init(100, "0");
        this.menuLayer.setAnchorPoint(cc.p(0, 0));
        this.menuLayer.setPosition(cc.p(0, 0));
        this.menuLayer.setScale(0.5);
        this.addChild(this.menuLayer, 0);

        //player
        this.playLayer = new Player();
        this.playLayer.init();
        this.addChild(this.playLayer, 0);

        //monster
        this.gameSceneMonster = new Monster();
        this.gameSceneMonster.init();
        this.addChild(this.gameSceneMonster, 0);

        //laser
        this.laser = new LaserManager();
        this.laser.init();
        this.laser.scheduleUpdate();
        this.addChild(this.laser);

        //collision detection
        this.scheduleUpdate();

        //opening collision detection
        this.isRectDetectedLock = false;
        this._STATUS = true;
    },
    init:function()
    {
        GameScene.Scene = this;
    },
    //when game over.
    gameOver:function()
    {
        var overLayer = new GameOver();

        if (!overLayer.init())
        {
            overLayer = null;
            return;
        }

        this.pause();

        this.menuLayer.unscheduleUpdate();

        this.addChild(overLayer, 10);
    },
    pause:function()
    {
        this._STATUS = false;
        this.playLayer.pause();
        this.moveMap.stop();
        this.gameSceneMonster.pause();
    },
    play:function()
    {
        this._STATUS = true;
        this.playLayer.play();
        if (this.moveMap.isMoving()) 
            this.moveMap.move();
        this.gameSceneMonster.play();
    },
    //tick: update all action of per-node in per-frame.
    update:function(dt)
    {
        if( !this._STATUS ) return;
        //get player amature
        var imManArmature = this.playLayer.imManArmature;
        // get player index
        var actionNum = this.playLayer.actionNum;
        // no repeat same action
        if(actionNum == ACTION_TYPE.ACTION_RUN)
        {
            this.playLayer.playerBoundingBox = cc.rect(imManArmature.getPosition().x-imManArmature.getContentSize().width/2+46,
                imManArmature.getPosition().y,imManArmature.getContentSize().width-90,imManArmature.getContentSize().height-50);
        }
        else if(actionNum == ACTION_TYPE.ACTION_STAND_JUMP)
        {
            this.playLayer.playerBoundingBox = cc.rect(imManArmature.getPosition().x-imManArmature.getContentSize().width/2+30,
                imManArmature.getPosition().y,imManArmature.getContentSize().width-50,imManArmature.getContentSize().height-50);
        }
        else if(actionNum == ACTION_TYPE.ACTION_RUN_JUMP)
        {
            this.playLayer.playerBoundingBox = cc.rect(imManArmature.getPosition().x-imManArmature.getContentSize().width/2+33,
                imManArmature.getPosition().y,imManArmature.getContentSize().width-70,imManArmature.getContentSize().height-50);
        }
        else if(actionNum == ACTION_TYPE.ACTION_RUN_STOP)
        {
            this.playLayer.playerBoundingBox = cc.rect(imManArmature.getPosition().x-imManArmature.getContentSize().width/2+40,
                imManArmature.getPosition().y,imManArmature.getContentSize().width-110,imManArmature.getContentSize().height-45);
        }
        else if(actionNum == ACTION_TYPE.ACTION_RUN_ATTACK)
        {
            this.playLayer.playerBoundingBox = cc.rect(imManArmature.getPosition().x-imManArmature.getContentSize().width/2,
                imManArmature.getPosition().y,imManArmature.getContentSize().width,imManArmature.getContentSize().height);
        }
        else if(actionNum == ACTION_TYPE.ACTION_STAND_ATTACK)
        {
            this.playLayer.playerBoundingBox = cc.rect(imManArmature.getPosition().x-imManArmature.getContentSize().width/2,
                imManArmature.getPosition().y,imManArmature.getContentSize().width,imManArmature.getContentSize().height);
        }
        else if(actionNum == ACTION_TYPE.ACTION_DEATH)
        {
            this.playLayer.playerBoundingBox = cc.rect(imManArmature.getPosition().x-imManArmature.getContentSize().width/2,
                imManArmature.getPosition().y,imManArmature.getContentSize().width,imManArmature.getContentSize().height);
        }

        if(this.gameSceneMonster.MonsterIndex == MonsterType.MonsterGround_enum)
        {
            this.gameSceneMonster.MonsterAmatureBoundingBox = cc.rect(this.gameSceneMonster.MonsterAmature.getPosition().x-
                this.gameSceneMonster.MonsterAmature.getContentSize().width/2+45,this.gameSceneMonster.MonsterAmature.getPosition().y+21,
                this.gameSceneMonster.MonsterAmature.getContentSize().width-90,this.gameSceneMonster.MonsterAmature.getContentSize().height-90);
        }
        else if(this.gameSceneMonster.MonsterIndex == MonsterType.MonsterSky_enum)
        {
            this.gameSceneMonster.MonsterAmatureBoundingBox = cc.rect(this.gameSceneMonster.MonsterAmature.getPosition().x-
                this.gameSceneMonster.MonsterAmature.getContentSize().width/2+45,this.gameSceneMonster.MonsterAmature.getPosition().y+21,
                this.gameSceneMonster.MonsterAmature.getContentSize().width-90,this.gameSceneMonster.MonsterAmature.getContentSize().height-90);
        }

        if (cc.rectIntersectsRect(this.playLayer.playerBoundingBox, this.gameSceneMonster.MonsterAmatureBoundingBox))
        {
            //this.unscheduleUpdate();
            //gameSceneMonster.MonsterDestroyAction();

            //var shark = CCShake.create(0.3, 10);
            //this.playLayer.runAction(shark);
            this.playLayer.imManArmatureBrood-=1;
            if(this.playLayer.imManArmatureBrood<1)
            {
                GameScene.getScene().menuLayer.setBloodBarPercent(0);
                this.unscheduleUpdate();
                this.playLayer.CMDeath();
                return;
            }

            GameScene.getScene().menuLayer.setBloodBarPercent(this.playLayer.imManArmatureBrood);
        }
    }
});

GameScene.Scene = null;
GameScene.getScene = function()
{
    return this.Scene;
}
